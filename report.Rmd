---
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
header-includes:
- \usepackage{xcolor}
- \usepackage{graphicx}
- \usepackage{tcolorbox} % For creating text boxes
- \usepackage{xcolor} % Use color package for customization
- \definecolor{whodarkblue}{RGB}{0, 32, 92}
- \definecolor{wholightblue}{RGB}{0, 154, 222}
- \definecolor{wholightblueshade}{RGB}{121, 181, 227}
- \definecolor{wholightblueshadev2}{RGB}{201, 221, 243}
- \definecolor{websitecolor}{RGB}{7, 113, 160}
- \setmainfont{Arial}
- \usepackage{fancyhdr} % Allows customization of headers and footers
- \pagestyle{fancy} % Enable fancy header/footer style
- \fancyhf{}
- "\\fancyhead[L]{\\color{whodarkblue} Health data overview   |   Afghanistan} % Add
  left-aligned content (e.g., section title)"
- \fancyhead[C]{} % Empty center
- "\\fancyhead[R]{\\color{whodarkblue}\\thepage} % Add right-aligned content (e.g.,
  author name)"
- \renewcommand{\headrule}{{\color{whodarkblue}\hrule width\headwidth height\headrulewidth}}
- \renewcommand{\headrulewidth}{0.6pt} % Add a horizontal line with thickness of 0.4pt
- \setlength{\headheight}{30pt} % Increase header height if needed
geometry: margin=1.75cm
---

\thispagestyle{empty}
\pagecolor{whodarkblue}

\begin{flushleft}
{\color{white}\rule{\linewidth}{0.25mm}} \\
\vspace{1.5cm}
{\fontsize{50}{60}\selectfont \color{white} Health Data Overview} \\
\vspace{1.5cm}
{\fontsize{25}{30}\selectfont \color{wholightblueshade} `r toupper("Afghanistan")`}

\vspace*{15cm} 

\end{flushleft}

\begin{flushright}
\includegraphics[width=5cm]{WHO-EN-W-H.png}
\end{flushright}


\newpage
\pagecolor{white}

```{r settings, echo= FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r parameters, echo = FALSE, message = FALSE, include = FALSE, eval = TRUE}
# list2env(params, .GlobalEnv)
```

```{r packages, include=FALSE}
library(tidyverse)
library(treemap)
library(ghost)
library(ggpol)
library(extrafont)
library(showtext)
library(patchwork)
library(cowplot)
library(ggnewscale)
library(flextable)
library(whoville)
library(ggrepel)
library(ggbump)
library(ggpubr)
library(ggh4x)
library(httr)
library(jsonlite)
library(emojifont)
library(flextable)
library(officer)


load("data_req.rda")
`%!in%` = Negate(`%in%`)

country_iso = "AFG"
country_ <- "Afghanistan"
m49code <- "004"

lev1 <- cod21 %>%
      filter(FLAG_LEVEL == 1) %>%
      select(FLAG_CAUSEGROUP, lev1_name = DIM_GHECAUSE_TITLE) %>%
      unique()

lev1_causes <- c("Communicable, maternal, perinatal and nutritional conditions", "Noncommunicable diseases", "Injuries", "Other COVID-19 pandemic-related outcomes")

colors <- c("Communicable, maternal, perinatal and nutritional conditions" = "#F26829",
            "Noncommunicable diseases" = "#009ADE",
            "Injuries" = "#80BC00",
            "Other COVID-19 pandemic-related outcomes" = "#A6228C")
year <- 2021
comp_year <- 2000
```

```{r region_info, include=FALSE}
who_region <- country_table %>% filter(Code == country_iso) %>% pull(ParentCode)
who_region_name <- case_when(
  who_region=="AFR" ~ "African Region",
  who_region=="AMR" ~ "Region of the Americas",
  who_region=="EMR" ~ "Eastern Mediterranean Region",
  who_region=="EUR" ~ "European Region",
  who_region=="SEAR" ~ "South-East Asia Region",
  who_region=="WPR" ~ "Western Pacific Region")
who_region_countries <- country_table %>% filter(ParentCode == who_region) %>% pull(Code) %>% substr(1,3) %>% unique()

if(who_region=="SEAR"){
h1 = 6
  }else{
h1 = 9
}
```

```{r text_values, include=FALSE}

# total population
total_pop2023 <- as.numeric(pop %>% filter(country == "Afghanistan" & year==2023) %>% pull(totalpop_jul))
total_pop2050 <- as.numeric(pop %>% filter(country == "Afghanistan" & year==2050) %>% pull(totalpop_jul))
total_pop_increase <- round(((as.numeric(total_pop2050) - as.numeric(total_pop2023)) / as.numeric(total_pop2023))*100, digits = 0)

# life expectany
le_2000 <- lehale %>% filter(IndicatorCode=="WHOSIS_000001" & sex=="Both sexes" & year==2000 & country == "Afghanistan") %>% pull(NumericValue)
le_2000_lwr <- lehale %>% filter(IndicatorCode=="WHOSIS_000001" & sex=="Both sexes" & year==2000 & country == "Afghanistan") %>% pull(Low)
le_2000_upr <- lehale %>% filter(IndicatorCode=="WHOSIS_000001" & sex=="Both sexes" & year==2000 & country == "Afghanistan") %>% pull(High)

le_2021 <- lehale %>% filter(IndicatorCode=="WHOSIS_000001" & sex=="Both sexes" & year==2021 & country == "Afghanistan") %>% pull(NumericValue)
le_2021_lwr <- lehale %>% filter(IndicatorCode=="WHOSIS_000001" & sex=="Both sexes" & year==2021 & country == "Afghanistan") %>% pull(Low)
le_2021_upr <- lehale %>% filter(IndicatorCode=="WHOSIS_000001" & sex=="Both sexes" & year==2021 & country == "Afghanistan") %>% pull(High)

change <- abs(le_2021 - le_2000)
change_text <- case_when(
 le_2021 < le_2000 ~ "decreased by",
 le_2000 < le_2021 ~ "improved by"
)

# total number of deaths
total_deaths <- cod21 %>%
    filter(sex=="Both sexes" & DIM_AGEGROUP_CODE == "TOTAL" & DIM_COUNTRY_CODE == country_iso & FLAG_LEVEL == 0) %>%
    pull(VAL_DEATHS_COUNT_NUMERIC)

# deaths by level 1
lev1_ <- cod21 %>%
    filter(sex=="Both sexes" & DIM_AGEGROUP_CODE == "TOTAL" & DIM_COUNTRY_CODE == country_iso & FLAG_LEVEL == 1) %>%
    mutate(cf = round(100 * VAL_DEATHS_COUNT_NUMERIC / total_deaths),
           DIM_GHECAUSE_TITLE = tolower(DIM_GHECAUSE_TITLE),
           DIM_GHECAUSE_TITLE = ifelse(DIM_GHECAUSE_TITLE=="other covid-19 pandemic-related outcomes", 
                                       "other COVID-19 pandemic-related outcomes", 
                                       DIM_GHECAUSE_TITLE)
           ) %>%
    select(DIM_GHECAUSE_TITLE, cf) %>%
    arrange(-cf)

```

```{r pop_pyramid, include=F, message=FALSE}
pop_data <- pop_age %>% 
  filter(country =="Afghanistan" & year %in% c(2023,2050)) %>% 
  mutate(ageg = factor(ageg, 
                       levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39",
                                  "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")
                       ))

max_lim <- max(pop_data$total_pop)
pop_data$total_pop <- ifelse(pop_data$sex == "Female", pop_data$total_pop*-1, pop_data$total_pop)

png("pop_pyramid.png", height = 790, width = 700)

# make plot
ggplot() + 
  geom_col(data = pop_data %>% filter(year==2050),
           aes(x= ageg, y = total_pop, fill = sex), width = 0.7, alpha = 0.3, show.legend = F)+
  geom_col(data = pop_data %>% filter(year==2023),
           aes(x= ageg, y = total_pop, fill = sex), width = 0.4, show.legend = F) +
  facet_wrap(~sex, scales = 'free_x', strip.position = "bottom") +
  coord_flip(clip = 'off') +
  scale_fill_manual(values = c("Male" = "#F4A81D",
                               "Female" = "#5B2C86"))+
  facetted_pos_scales(
    y = list(scale_y_continuous(limits = c(-max_lim, 0), expand = c(0,0),
                                ),
             scale_y_continuous(limits = c(0, max_lim), expand = c(0,0),
                                )
             )
    ) +
  labs(title = "Demographic change, 2023-2050")+
  theme_classic() +
  theme(
      strip.background = element_blank(),
      strip.text = element_text(family="calibri", size = 20),
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(color = "white"),
      axis.line.x = element_blank(),
      axis.line.y = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.major.y = element_line(color = "grey"),
      axis.text.y = element_text(family="calibri", size = 18, color = "black"),
      plot.title = element_text(size = 20, color = "#00205C")
    )  

dev.off()

# test2 <- ggplot() +
#   geom_col(data = pop_data %>% filter(sex=="Female" & ageg=="10-14"),
#            aes(x=ageg, y = total_pop, fill = as.character(year)), position = position_dodge())+
#   scale_fill_manual(values = c("2023" = "#5B2C86", "2050" = "#ccb7e0"))+
#     theme_classic()+
#     theme(legend.title = element_blank(),
#           legend.position = "top",
#           legend.text = element_text(size = 16, margin = margin(r = 20, t = 0, l = 10, b = 0, unit = "pt"))
#           )
# 
# png("legend_pop_pyramid.png", height = 30, width = 200)
# leg <- get_legend(test2)
# as_ggplot(leg)
# dev.off()
```

\begin{minipage}{0.45\textwidth}
\begin{tcolorbox}[colback=wholightblueshadev2, colframe=wholightblueshadev2, title=Overview, coltitle=whodarkblue, fonttitle=\Large\bfseries, height=11cm, boxsep=2mm]

In Afghanistan, the population as of 2023 is `r format(total_pop2023*1000, big.mark = " ")` with a projected increase of `r total_pop_increase`\% to `r format(total_pop2050*1000, big.mark = " ")` by 2050.
\\
\\
Life expectancy at birth (years) has `r change_text` `r round(change,1)` years from `r round(le_2000,1)` [`r round(le_2000_lwr,1)` - `r round(le_2000_upr,1)`] years in 2000 to `r round(le_2021,1)` [`r round(le_2021_lwr,1)` - `r round(le_2021_upr,1)`] years in 2021.
\\
\\
`r country_` had `r format(round(total_deaths), big.mark=" ", scientific=F)` total deaths in 2021; `r lev1_[1,2]`\% of deaths were from `r lev1_[1,1]`; `r lev1_[2,2]`\% were from `r lev1_[2,1]`; `r lev1_[3,2]`\% were from `r lev1_[3,1]`; and `r lev1_[4,2]`\% were from `r lev1_[4,1]`.

\end{tcolorbox}
\end{minipage}
\hfill
\begin{minipage}{0.5\textwidth}
\includegraphics{pop_pyramid.png}
\includegraphics[height=0.5cm]{legend_pop_pyramid.png}
\end{minipage}
\
\
\rule{\textwidth}{0.6pt}\color{whodarkblue}
\normalsize Life expectancy and healthy life expectancy by sex, 2000â€“2021
```{r life_exp_bysex, fig.height=4.4, fig.align='center', fig.width=8}
exp <- lehale %>% 
  filter(IndicatorCode=="WHOSIS_000002" | IndicatorCode=="WHOSIS_000001") %>%
  filter(country=="Afghanistan") %>% 
  mutate(name = ifelse(IndicatorCode=="WHOSIS_000001", "Life expectancy at birth (years)", "Healthy life expectancy at birth (years)")) %>% 
  select(country, year, sex, name, value = NumericValue) %>% 
  mutate(value = round(value, 1)) %>% 
  mutate(name = factor(name, levels = c("Life expectancy at birth (years)", "Healthy life expectancy at birth (years)")))

max <- exp %>% select(value) %>% arrange(desc(value)) %>% filter(row_number()==1) %>% pull()
min <- exp %>% select(value) %>% arrange(value) %>% filter(row_number()==1) %>% pull()

ggplot()+
  geom_line(data = exp, aes(x=year, y=value, color=sex), size = 1) +
  geom_point(data = exp %>% filter(year==2021), aes(x=year, y=value, color=sex), size = 1.5, show.legend = F) +
  geom_text(data = exp %>% filter(year==2021),
            mapping = aes(x = 2021.5, y = value, label = sprintf('%.1f', value), color = sex), show.legend = F, hjust = 0
    # mapping = aes(x = 2021.5, y = value, label = paste0(value, " (", sex, ")"), color = sex), show.legend = F, hjust = 0
    ) +
  facet_wrap(~name, scales = 'free_x', strip.position = "top") +
  scale_y_continuous(limits = c(round(min, 0)-2,round(max, 0)+2)) +
  scale_x_continuous(limits = c(2000, 2024), breaks = c(2000, 2010, 2021)) +
  scale_color_manual(values = c("Male" = "#F4A81D",
                               "Female" = "#5B2C86",
                               "Both sexes" = "#009ADE")) +
  theme_classic()+
  theme(axis.text=element_text(size=9),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 10, color = "black"),
        axis.line.y = element_blank(),
        axis.line.x = element_line(color = "darkgrey",linetype = 3),
        panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3),
        panel.grid = element_blank(),
        panel.spacing = unit(2, "lines"),
        panel.background = element_rect(fill = "white"),
        strip.background = element_blank(),
        strip.text = element_text(size = 10)
)
```

\newpage
\includegraphics[width=17cm]{legend_test.PNG}
\
\
Top 10 causes of death, 2000-2021
``` {r top10, fig.height=2.9, fig.align='center'}
b <- cod21 %>% 
  filter(country == country_ & FLAG_LEVEL==2 & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL") %>%
  select(country, DIM_GHECAUSE_TITLE, VAL_DEATHS_COUNT_NUMERIC, DIM_YEAR_CODE, FLAG_CAUSEGROUP) %>% 
  mutate(prop_deaths = VAL_DEATHS_COUNT_NUMERIC / sum(VAL_DEATHS_COUNT_NUMERIC),
         rank_deaths = rank(-prop_deaths, ties.method = "first")) %>% 
  rbind(cod00 %>% 
          filter(country == country_ & FLAG_LEVEL==2 & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL") %>%
          select(country, DIM_GHECAUSE_TITLE, VAL_DEATHS_COUNT_NUMERIC, DIM_YEAR_CODE, FLAG_CAUSEGROUP) %>% 
          mutate(prop_deaths = VAL_DEATHS_COUNT_NUMERIC / sum(VAL_DEATHS_COUNT_NUMERIC),
                 rank_deaths = rank(-prop_deaths, ties.method = "first"))) %>% 
  pivot_wider(id_cols = c(FLAG_CAUSEGROUP, DIM_GHECAUSE_TITLE), names_from = DIM_YEAR_CODE,
                  values_from = c(rank_deaths)) %>%
  filter(`2000`<11 | `2021`<11) %>% 
  left_join(lev1, by = "FLAG_CAUSEGROUP") %>% 
  pivot_longer(cols = c(`2000`, `2021`)) %>% 
  mutate(year = as.numeric(name),
         label = paste0(value, ". ", DIM_GHECAUSE_TITLE))

    
b %>% 
  ggplot(aes(x = year, y = -value, group = DIM_GHECAUSE_TITLE, color = lev1_name)) +
  geom_bump(size = 3, show.legend = F, alpha = 0.4) +
  geom_bump(size = 0.6, show.legend = F, alpha = 1) +
  geom_point(size = 6, show.legend = F) +
  geom_text(data = b %>% filter(year == 2000),
            aes(x = year, y = -value, label = value),
            size = 3, show.legend = F, color = "black") +
  geom_text(data = b %>% filter(year == 2021),
            aes(x = year, y = -value, label = value),
            size = 3, show.legend = F, color = "black") +
  geom_text(data = b %>% filter(year == 2000),
            aes(x = year - 1, y = -value, label = str_wrap(DIM_GHECAUSE_TITLE,25)),
            size = 3, hjust = 1, show.legend = F, color = "black") +
  geom_text(data = b %>% filter(year == 2021),
            aes(x = year + 1, y = -value, label = str_wrap(DIM_GHECAUSE_TITLE,25)),
            size = 3, hjust = 0, show.legend = F, color = "black") +
  scale_x_continuous(limits = c(1985, 2036))+
  # scale_color_manual(values = c("#F26829", "#009ADE", "#80BC00")) +
  scale_color_manual(values = c(
    "Communicable, maternal, perinatal and nutritional conditions" ="#F26829",
    "Noncommunicable diseases" = "#009ADE",
    "Injuries" = "#80BC00",
    "Other COVID-19 pandemic-related outcomes" = "#A6228C"
  )) +
  theme_void() +
  guides(color=guide_legend(ncol=1))
```
\rule{\textwidth}{0.6pt}\color{whodarkblue}
Overall causes of death, 2021
```{r lev1barchart, fig.height=1.5, fig.align='center', fig.width=8}
d <- cod21 %>%
  filter(country == country_ & FLAG_LEVEL==1 & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL") %>%
  select(country, DIM_GHECAUSE_TITLE, VAL_DEATHS_COUNT_NUMERIC, DIM_YEAR_CODE) %>%
  #Region info
  rbind(cod21 %>%
          filter(region == who_region & FLAG_LEVEL==1 & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL") %>%
            group_by(region2, DIM_GHECAUSE_TITLE, DIM_YEAR_CODE) %>%
            summarise(VAL_DEATHS_COUNT_NUMERIC = sum(VAL_DEATHS_COUNT_NUMERIC)) %>%
            ungroup() %>% rename(country = region2)) %>%
  #Global info
  rbind(cod21 %>%
          filter(FLAG_LEVEL==1 & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL") %>%
            group_by(DIM_GHECAUSE_TITLE, DIM_YEAR_CODE) %>%
            summarise(VAL_DEATHS_COUNT_NUMERIC = sum(VAL_DEATHS_COUNT_NUMERIC)) %>%
            ungroup() %>% mutate(country = "Global")) %>%
  group_by(country, DIM_YEAR_CODE) %>%
  mutate(pct = paste0((round(VAL_DEATHS_COUNT_NUMERIC/sum(VAL_DEATHS_COUNT_NUMERIC)*100, 0)),"%")) %>%
  ungroup() %>%
  mutate(country = factor(country, levels = c(country_, who_region_name, "Global")),
         DIM_GHECAUSE_TITLE = factor(DIM_GHECAUSE_TITLE, levels = lev1_causes))

d %>% 
  ggplot(aes(x = country, y = VAL_DEATHS_COUNT_NUMERIC, fill = forcats::fct_rev(DIM_GHECAUSE_TITLE))) +
  geom_col(position = "fill", show.legend = F, width = 0.5) +
  geom_text(data = d %>% filter(pct %!in% c("0%", "1%", "2%")), aes(label = pct), position = position_fill(vjust = 0.5), show.legend = F, size = 3)+
  geom_text(data = d %>% filter(DIM_GHECAUSE_TITLE=="Injuries"), aes(y = 0, x = country, label = country), size = 3, vjust = -2, hjust = 0) + 
  coord_flip()+
  theme_void() +
  theme(plot.margin = margin(t=0, l=0,r=0, b=0, unit = "cm"))+
  # theme(axis.text.y = element_text(size = 8)) +
  scale_fill_manual(values = colors)
```
\rule{\textwidth}{0.6pt}\color{whodarkblue}
Detailed causes of death, 2021
``` {r treemap, fig.height=2.9, fig.align='center'}

data_treemap <- cod21 %>%
    filter(DIM_COUNTRY_CODE == country_iso & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL" & FLAG_TREEMAP == 1)

data_treemap <- data_treemap %>% left_join(lev1, by = "FLAG_CAUSEGROUP")
data_treemap$lev1_name <- factor(data_treemap$lev1_name, levels = lev1_causes)

data_treemap <- data_treemap %>%
  mutate(cause_fraction = VAL_DEATHS_COUNT_NUMERIC / sum(VAL_DEATHS_COUNT_NUMERIC)) %>%
  mutate(cause_title = ifelse(cause_fraction > 0.01,
                                paste(DIM_GHECAUSE_TITLE, sprintf("(%1.1f%%)", 100*cause_fraction), sep = " "),
                                DIM_GHECAUSE_TITLE)) %>%
  mutate(mycolor = case_when(
      lev1_name=="Communicable, maternal, perinatal and nutritional conditions" ~"#F26829",
      lev1_name=="Noncommunicable diseases" ~ "#009ADE",
      lev1_name=="Injuries" ~ "#80BC00",
      lev1_name=="Other COVID-19 pandemic-related outcomes" ~ "#A6228C"
    )) %>%
  mutate(mycolor = ifelse(is.na(cause_title), NA, mycolor))

  # get total death count for title
total_deaths <- cod21 %>% 
  filter(DIM_COUNTRY_CODE == country_iso & FLAG_LEVEL == 0 & sex=="Both sexes" & DIM_AGEGROUP_CODE=="TOTAL") %>%
  pull(VAL_DEATHS_COUNT_NUMERIC) %>% round()

  # make treemap
treemap::treemap(data_treemap,
          index=c("lev1_name","cause_title"),
          vSize="VAL_DEATHS_COUNT_NUMERIC",
          type="color",
          vColor = "mycolor",
          fontsize.labels=c(0,9),
          # fontcolor.labels=c("white","white"),
          fontcolor.labels=c("black","black"),
          fontface.labels=c(2,1),
          fontfamily.labels=c("sans"),
          fontfamily.title = "sans",
          bg.labels=c("transparent"),
          border.col=c("white","white"),
          # border.col=c("black","black"),
          align.labels=list(
            c("center", "center"),
            c("left", "top")
          ),
          overlap.labels=0.5,
          inflate.labels=F,
          position.legend = "none",
          fontsize.title = 8,
          title=paste0("Total deaths: ", format(total_deaths, big.mark = " ", scientific = F))
  )
```
\tiny Note: Communicable diseases includes maternal, perinatal and nutritional conditions.
\newpage
\includegraphics[width=17cm]{legend_test.PNG}
\
\
\normalsize Top causes of death by sex, 2021
\small   (deaths per 100 000 population)
```{r cod2021, fig.height=4, fig.align='center', fig.width=8}
cod <- cod21 %>% 
  filter(country=="Afghanistan" & FLAG_TREEMAP==1 & DIM_AGEGROUP_CODE=="TOTAL" & sex!="Both sexes") %>% 
  group_by(country, sex) %>%
  arrange(region, sex, desc(VAL_DEATHS_RATE100K_NUMERIC)) %>%
  slice(1:10) 

max_lim <- max(cod$VAL_DEATHS_RATE100K_NUMERIC)

ref <- cod21 %>% 
  filter(FLAG_TREEMAP==1) %>% 
  distinct(DIM_GHECAUSE_TITLE, FLAG_CAUSEGROUP) %>% 
  left_join(cod21 %>% filter(FLAG_LEVEL==1) %>% distinct(FLAG_CAUSEGROUP, DIM_GHECAUSE_TITLE) %>% rename(lev1 = DIM_GHECAUSE_TITLE))

codf <- cod %>% 
  filter(sex=="Female") %>% 
  left_join(ref) %>% 
  ggplot(aes(x=reorder(str_wrap(DIM_GHECAUSE_TITLE, 20), VAL_DEATHS_RATE100K_NUMERIC), y = VAL_DEATHS_RATE100K_NUMERIC, fill = lev1))+
  # geom_text(aes(x=reorder(str_wrap(DIM_GHECAUSE_TITLE, 20), VAL_DEATHS_RATE100K_NUMERIC), 
  #               y = VAL_DEATHS_RATE100K_NUMERIC, 
  #               label = round(VAL_DEATHS_RATE100K_NUMERIC, 1)),
  #           size = 3, color = "darkgrey", hjust = 0) +
  # geom_text(aes(x=reorder(str_wrap(DIM_GHECAUSE_TITLE, 20), VAL_DEATHS_RATE100K_NUMERIC), y = -8, label = round(VAL_DEATHS_RATE100K_NUMERIC, 1)),
  #           size = 2.8, color = "black") +
  geom_bar(stat = "identity", show.legend = F, width = 0.6, color = "black") +
  coord_flip() +
  scale_fill_manual(values = colors) +
  scale_y_continuous(limits = c(0,max_lim)) +
  labs(title = "Female") +
  theme_classic()+
  theme(
    panel.grid.major.x = element_line(color = "grey"),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    # axis.text.x = element_blank(),
    axis.text.y = element_text(size = 9, hjust = 0, color = "black"),
    plot.title = element_text(size = 9)
  )

codm <- cod %>% 
  filter(sex=="Male") %>% 
  left_join(ref) %>% 
  ggplot(aes(x=reorder(str_wrap(DIM_GHECAUSE_TITLE, 20), VAL_DEATHS_RATE100K_NUMERIC), y = VAL_DEATHS_RATE100K_NUMERIC, fill = lev1))+
  # geom_text(aes(x=reorder(str_wrap(DIM_GHECAUSE_TITLE, 20), VAL_DEATHS_RATE100K_NUMERIC), 
  #               y = VAL_DEATHS_RATE100K_NUMERIC, 
  #               label = round(VAL_DEATHS_RATE100K_NUMERIC, 1)),
  #           size = 3, color = "darkgrey", hjust = 0) +
  # geom_text(aes(x=reorder(str_wrap(DIM_GHECAUSE_TITLE, 20), VAL_DEATHS_RATE100K_NUMERIC), y = -14, label = round(VAL_DEATHS_RATE100K_NUMERIC, 1)), 
  #           size = 2.8, color = "black") +
  geom_bar(stat = "identity", show.legend = F, width = 0.6, color = "black") +
  coord_flip() +
  scale_fill_manual(values = colors) +
  scale_y_continuous(limits = c(0,max_lim)) +
  labs(title = "Male") +
  theme_classic()+
  theme(
    panel.grid.major.x = element_line(color = "grey"),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    # axis.text.x = element_blank(),
    axis.text.y = element_text(size = 9, hjust = 0, color = "black"),
    plot.title = element_text(size = 9)
  )

patchwork::wrap_plots(codf, codm, ncol = 2) 
#& theme(plot.margin = unit(c(0.05,0,0,0), "cm"))
```
\rule{\textwidth}{0.6pt}\color{whodarkblue}
\normalsize Disability adjusted life-years (DALYs) by sex, 2021 
\small   (DALYs per 100 0000 population)
```{r dalybysex, fig.align='center', fig.height=4, fig.width=8}

d3 <- data_pyramid %>% 
  filter(country == country_ & FLAG_LEVEL==1 & sex %in% c("Male", "Female") & DIM_AGEGROUP_CODE=="TOTAL") %>%
  select(country, sex, DIM_GHECAUSE_TITLE, VAL_DALY_COUNT_NUMERIC, ATTR_POPULATION_NUMERIC) %>% 
  rbind(data_pyramid %>%
          filter(region == who_region & FLAG_LEVEL==1 & sex %in% c("Male", "Female") & DIM_AGEGROUP_CODE=="TOTAL") %>%
            group_by(region2, sex, DIM_GHECAUSE_TITLE) %>%
            summarise(VAL_DALY_COUNT_NUMERIC = sum(VAL_DALY_COUNT_NUMERIC),
                      ATTR_POPULATION_NUMERIC = sum(ATTR_POPULATION_NUMERIC)) %>%
            ungroup() %>% rename(country = region2)) %>%
  # mutate(VAL_DALY_COUNT_NUMERIC = VAL_DALY_COUNT_NUMERIC/1000000)
  mutate(daly_100 = round((VAL_DALY_COUNT_NUMERIC/ATTR_POPULATION_NUMERIC)*100000, 0))

max_lim <- max(d3$daly_100)
d3$daly_100 <- ifelse(d3$sex == "Female", d3$daly_100 *-1, d3$daly_100)
min_lim <- min(d3$daly_100)

# max_lim <- max(d3$VAL_DALY_COUNT_NUMERIC)
# d3$VAL_DALY_COUNT_NUMERIC <- ifelse(d3$sex == "Female", d3$VAL_DALY_COUNT_NUMERIC *-1, d3$VAL_DALY_COUNT_NUMERIC)
# min_lim <- min(d3$VAL_DALY_COUNT_NUMERIC)


# make plot
ggplot() + 
  geom_col(data = d3 %>% filter(country== who_region_name),
           aes(x= str_wrap(DIM_GHECAUSE_TITLE, 15), y = daly_100, fill = DIM_GHECAUSE_TITLE), width = 0.8, alpha = 0.3, show.legend = F)+
  geom_col(data = d3 %>% filter(country== country_),
           aes(x= str_wrap(DIM_GHECAUSE_TITLE, 15), y = daly_100, fill = DIM_GHECAUSE_TITLE), width = 0.4, show.legend = F, color = "black") +
  facet_share(~sex, dir = "h", 
                scales = 'free') + 
  coord_flip(clip = 'off') +
  scale_fill_manual(values = colors)+
  scale_x_discrete(limits = rev)+
  facetted_pos_scales(
    y = list(scale_y_continuous(limits = c(-max_lim, 0),
                                labels = ~scales::label_number()(abs(.x))),
             scale_y_continuous(limits = c(0, max_lim),
                                labels = ~scales::label_number()(abs(.x)))
    )
    ) +
  theme_classic() +
  theme(
      strip.background = element_blank(),
      plot.margin = unit(c(0,0,0,-2.5), "cm"),
      strip.text = element_text(size = 9),
      axis.title.y = element_blank(),
      # axis.title.x = element_text(size = 9, color = "black"),
      axis.title.x = element_blank(),
      axis.ticks.y = element_line(color = "white"),
      axis.line.x = element_blank(),
      panel.grid.major.x = element_line(color = "grey"),
      axis.text.y = element_text(size = 9, color = "black")
    ) 
# +
#     labs(y = "DALYs") 
```
\small `r who_region_name` are the lightly shaded bars.

\newpage
```{r sdg prep, include=F, message=F, warning=F}
getind <- function(){
  ind <- GET(url = "https://ghoapi.azureedge.net/api/Indicator")
  ind2 = fromJSON(rawToChar(ind$content))
  ind3 <- ind2[2]$value
  return(ind3)
}
ind_func <- getind()

url <- paste0("https://xmart-api-public.who.int/DATA_/RELAY_MAY2023?$filter=DIM_GEO_CODE_M49%20eq%20'", m49code, "'")
response <- GET(url)
# response <- GET("https://xmart-api-public.who.int/DATA_/RELAY_MAY2023?$filter=IND_UUID%20eq%20'8074BD9'")
resultTxt <- content(response, "text")
resultJson <- fromJSON(resultTxt, flatten = T)
sdgtest <- resultJson$value 

sdgtest_ <- sdgtest %>% 
  select(- c("_RecordID", "Sys_RowTitle", "Sys_Version", "Sys_VersionID", "Sys_OriginCode", "Sys_LoadBy", "Sys_CommitDateUtc", 
             "Sys_FirstLoadBy", "Sys_FirstCommitDateUtc", "Sys_ID", "Sys_BatchID", "Sys_FirstBatchID", "Sys_PK", "OBSERVATION_STATUS")) %>% 
  filter(DIM_TIME_TYPE != "YEAR_RANGE") %>% 
  mutate(DIM_TIME = as.numeric(DIM_TIME)) %>% 
  filter(DIM_TIME>=2000) %>% 
  left_join(ind_func %>% select(-c(Language)) %>% rename(IND_CODE = IndicatorCode)) %>% 
  arrange(IndicatorName, DIM_TIME)

# sdg_ref <- sdgtest_ %>% 
#   distinct(IND_CODE, IND_UUID, IndicatorName, DIM_MEMBER_1_CODE, DIM_MEMBER_2_CODE)
# write.csv(sdg_ref, "sdg_ref.csv")

sdg_ref <- read.csv("sdg_ref_final.csv")
dec_ref <- readxl::read_xlsx("Rounding_WHS2024.xlsx")
```
\large Health Statistics: Health Status \normalsize (selected indicators)
\vspace{-0.5cm}
```{r health status, fig.height=10.3, fig.width = 8, fig.align='center', message=F, warning=F}
sdg_hstat <- sdg_ref %>% 
  filter(group=="health status") %>% 
  select(IND_UUID, DIM_MEMBER_1_CODE, DIM_MEMBER_2_CODE, increase_good) %>% 
  left_join(sdgtest_)

hstat <- rbind(
  sdg_hstat %>% group_by(IND_UUID) %>% top_n(1, DIM_TIME) %>% mutate(year = "new"),
  sdg_hstat %>% group_by(IND_UUID) %>% top_n(-1, DIM_TIME)%>% mutate(year = "old")
) 
hstat_ <- hstat %>% 
  select(IND_UUID, IND_CODE, year, VALUE_NUMERIC) %>% 
  pivot_wider(values_from = VALUE_NUMERIC, names_from = year) %>% 
  mutate(perc = ((new-old)/old)*100) %>% 
  mutate(perc_abs = abs(perc)) %>% 
  arrange(desc(perc_abs)) %>% 
  ungroup() %>% 
  slice(1:6) %>% 
  mutate(graph = 1,
         row = row_number())

hstat_final <- hstat %>% left_join(hstat_)
  
ind_hstat <- hstat_final %>% filter(graph==1) %>% arrange(row) %>% distinct(IND_UUID) %>%  pull(IND_UUID)

for (i in ind_hstat){
  
  message(i)
  name <- sdg_ref %>% filter(IND_UUID==i) %>% pull(website_name) ; message(name)
  plot_num <- hstat_final %>% filter(IND_UUID==i) %>% pull(row); message(plot_num)
  data_i <- hstat_final %>% filter(IND_UUID==i)
  ind_code <- hstat_final %>% filter(IND_UUID==i) %>% distinct(IND_CODE) %>% pull()
  dec_num <- dec_ref %>% filter(DimensionMemberCode==ind_code) %>% pull(decimals); dec_num <- as.numeric(dec_num)
  
  min_year <- min(data_i %>%  pull(DIM_TIME))
  max_year <- max(data_i %>%  pull(DIM_TIME))
  mid_year <- round((max_year+min_year)/2, digits = 0)
  
  mid_value <- (max(data_i %>% pull(VALUE_NUMERIC))+min(data_i %>% pull(VALUE_NUMERIC)))/2
  perc_label <- round(data_i %>%  distinct(perc) %>% pull(perc), 1)
  increase_good <- unique(data_i %>% pull(increase_good))
  color_code <- ifelse(increase_good==0,
                       case_when(perc_label<0 ~ "#80BC00", perc_label>0 ~ "#EF3842", perc_label==0 ~ "#F4A81D"),
                       case_when(perc_label<0 ~ "#EF3842", perc_label>0 ~ "#80BC00", perc_label==0 ~ "#F4A81D")
  )
  arrow_code <- 
    case_when(
    perc_label<0 ~ sprintf('\u2193'),
    perc_label>0 ~ sprintf('\u2191'),
    perc_label==0 ~ sprintf('\u2192'),
  )

  plot <- data_i %>% 
    ggplot(aes(x=DIM_TIME, y = VALUE_NUMERIC)) +
    labs(title = str_wrap(name, 50))+
    geom_line(color = "#009ADE", size = 1)+
    geom_point(color = "#009ADE", size = 2)+
    # geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = sprintf('%.1f', round(VALUE_NUMERIC, dec_num)))) +
    geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(round(VALUE_NUMERIC, dec_num), big.mark = " ", nsmall = dec_num))) +
    annotate("label", x=max_year, y = mid_value, label = paste0(arrow_code, " ", perc_label, "%"), 
             color = color_code, label.padding = unit(0.8, "lines"), label.r = unit(0.8, "lines")) +
    scale_x_continuous(limits = c(2000, 2025), breaks = c(min_year, max_year), n.breaks = 3)+
    scale_y_continuous(labels=function(x) format(x, big.mark = " ", scientific = FALSE, nsmall = dec_num))+
    theme_classic()+
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3)
  )
  
  assign(paste0("ind", plot_num), plot)
}

wrap_plots(ind1, ind2, ind3, ind4, ind5, ind6, ncol = 2)
```

\newpage

\large Health Statistics: Risk Factors \normalsize (selected indicators)
\vspace{-0.5cm}
```{r risk factors, fig.height=10.3, fig.width = 8, fig.align='center', message=F, warning=F}

sdg_risk <- sdg_ref %>% 
  filter(group=="risk factors") %>% 
  select(IND_UUID, DIM_MEMBER_1_CODE, DIM_MEMBER_2_CODE, increase_good) %>% 
  left_join(sdgtest_)

risk <- rbind(
  sdg_risk %>% group_by(IND_UUID) %>% top_n(1, DIM_TIME) %>% mutate(year = "new"),
  sdg_risk %>% group_by(IND_UUID) %>% top_n(-1, DIM_TIME)%>% mutate(year = "old")
) 
risk_ <- risk %>% 
  select(IND_UUID, IND_CODE, year, VALUE_NUMERIC) %>% 
  pivot_wider(values_from = VALUE_NUMERIC, names_from = year) %>% 
  mutate(perc = ((new-old)/old)*100) %>% 
  mutate(perc_abs = abs(perc)) %>% 
  arrange(desc(perc_abs)) %>% 
  ungroup() %>% 
  slice(1:6) %>% 
  mutate(graph = 1,
         row = row_number())

risk_final <- risk %>% left_join(risk_)
  
ind_risk <- risk_final %>% filter(graph==1) %>% arrange(row) %>% distinct(IND_UUID) %>%  pull(IND_UUID)

for (i in ind_risk){
  
  message(i)
  name <- sdg_ref %>% filter(IND_UUID==i) %>% pull(website_name) ; message(name)
  plot_num <- risk_final %>% filter(IND_UUID==i) %>% pull(row); message(plot_num)
  data_i <- risk_final %>% filter(IND_UUID==i)
  ind_code <- risk_final %>% filter(IND_UUID==i) %>% distinct(IND_CODE) %>% pull()
  dec_num <- dec_ref %>% filter(DimensionMemberCode==ind_code) %>% pull(decimals); dec_num <- as.numeric(dec_num)
  
  min_year <- min(data_i %>% pull(DIM_TIME))
  max_year <- max(data_i %>% pull(DIM_TIME))
  mid_year <- round((max_year+min_year)/2, digits = 0)
  
  mid_value <- (max(data_i %>% pull(VALUE_NUMERIC))+min(data_i %>% pull(VALUE_NUMERIC)))/2
  perc_label <- round(data_i %>% distinct(perc) %>% pull(perc), 1)
  increase_good <- unique(data_i %>% pull(increase_good))
  color_code <- ifelse(increase_good==0,
                       case_when(perc_label<0 ~ "#80BC00", perc_label>0 ~ "#EF3842", perc_label==0 ~ "#F4A81D"),
                       case_when(perc_label<0 ~ "#EF3842", perc_label>0 ~ "#80BC00", perc_label==0 ~ "#F4A81D")
  )
  arrow_code <- 
    case_when(
    perc_label<0 ~ sprintf('\u2193'),
    perc_label>0 ~ sprintf('\u2191'),
    perc_label==0 ~ sprintf('\u2192'),
  )
  
  plot <- data_i %>% 
    ggplot(aes(x=DIM_TIME, y = VALUE_NUMERIC)) +
    labs(title = str_wrap(name, 50))+
    geom_line(color = "#009ADE", size = 1)+
    geom_point(color = "#009ADE", size = 2)+
    # geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(sprintf('%.1f', round(VALUE_NUMERIC, 1)), big.mark = ","))) +
    geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(round(VALUE_NUMERIC, dec_num), big.mark = " ", nsmall = dec_num))) +
    annotate("label", x=max_year, y = mid_value, label = paste0(arrow_code, " ", perc_label, "%"), 
             color = color_code, label.padding = unit(0.8, "lines"), label.r = unit(0.8, "lines")) +
    scale_x_continuous(limits = c(2000, 2025), breaks = c(min_year, max_year), n.breaks = 3)+
    scale_y_continuous(labels=function(x) format(x, big.mark = " ", scientific = FALSE, nsmall = dec_num))+
    theme_classic()+
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3)
  )
  
  assign(paste0("ind", plot_num), plot)
}

wrap_plots(ind1, ind2, ind3, ind4, ind5, ind6, ncol = 2)
```
\newpage

\large Health Statistics: Service Coverage
\vspace{-0.5cm}
```{r service coverage, fig.height=7, fig.width = 8, fig.align='center', message=F, warning=F}

sdg_sc <- sdg_ref %>% 
  filter(group=="service coverage") %>% 
  select(IND_UUID, DIM_MEMBER_1_CODE, DIM_MEMBER_2_CODE, increase_good) %>% 
  left_join(sdgtest_)

sc <- rbind(
  sdg_sc %>% group_by(IND_UUID) %>% top_n(1, DIM_TIME) %>% mutate(year = "new"),
  sdg_sc %>% group_by(IND_UUID) %>% top_n(-1, DIM_TIME)%>% mutate(year = "old")
) 
sc_ <- sc %>% 
  select(IND_UUID, IND_CODE, year, VALUE_NUMERIC) %>% 
  pivot_wider(values_from = VALUE_NUMERIC, names_from = year) %>% 
  mutate(perc = ((new-old)/old)*100) %>% 
  mutate(perc_abs = abs(perc)) %>% 
  arrange(desc(perc_abs)) %>% 
  ungroup() %>% 
  # slice(1:6) %>% 
  mutate(graph = 1,
         row = row_number())

sc_final <- sc %>% left_join(sc_)
  
ind_sc <- sc_final %>% filter(graph==1) %>% arrange(row) %>% distinct(IND_UUID) %>%  pull(IND_UUID)

for (j in 1:length(ind_sc)){
  
  message(j)
  i <- sc_final %>% filter(graph==1 & row ==j) %>% pull(IND_UUID)
  name <- sdg_ref %>% filter(IND_UUID==i) %>% pull(website_name) ; message(name)
  # plot_num <- sc_final %>% filter(IND_UUID==i) %>% pull(row); message(plot_num)
  data_i <- sc_final %>% filter(IND_UUID==i)
  ind_code <- sc_final %>% filter(IND_UUID==i) %>% distinct(IND_CODE) %>% pull()
  dec_num <- dec_ref %>% filter(DimensionMemberCode==ind_code) %>% pull(decimals); dec_num <- as.numeric(dec_num)
  
  
  if(unique(i)=="2D6FBE4"){
    data_i <- data_i %>% mutate(VALUE_NUMERIC = VALUE_NUMERIC/1000000)

  min_year <- min(data_i %>% pull(DIM_TIME))
  max_year <- max(data_i %>% pull(DIM_TIME))
  mid_year <- round((max_year+min_year)/2, digits = 0)
  
  mid_value <- (max(data_i %>% pull(VALUE_NUMERIC))+min(data_i %>% pull(VALUE_NUMERIC)))/2
  perc_label <- round(data_i %>% distinct(perc) %>% pull(perc), 1)
  increase_good <- unique(data_i %>% pull(increase_good))
  color_code <- ifelse(increase_good==0,
                       case_when(perc_label<0 ~ "#80BC00", perc_label>0 ~ "#EF3842", perc_label==0 ~ "#F4A81D"),
                       case_when(perc_label<0 ~ "#EF3842", perc_label>0 ~ "#80BC00", perc_label==0 ~ "#F4A81D")
  )
  arrow_code <- 
    case_when(
    perc_label<0 ~ sprintf('\u2193'),
    perc_label>0 ~ sprintf('\u2191'),
    perc_label==0 ~ sprintf('\u2192'),
  )
    
    plot <- data_i %>% 
    ggplot() +
    labs(title = str_wrap(name, 50))+
    geom_line(aes(x=DIM_TIME, y = VALUE_NUMERIC), color = "#009ADE", size = 1)+
    geom_point(aes(x=DIM_TIME, y = VALUE_NUMERIC), color = "#009ADE", size = 2)+
    # geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(sprintf('%.1f', round(VALUE_NUMERIC, 1)), big.mark = ","))) +
    geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(round(VALUE_NUMERIC, dec_num), big.mark = " ", nsmall = dec_num))) +
    annotate("label", x=max_year, y = mid_value, label = paste0(arrow_code, " ", perc_label, "%"), 
             color = color_code, label.padding = unit(0.8, "lines"), label.r = unit(0.8, "lines")) +
    scale_x_continuous(limits = c(2000, 2025), breaks = c(min_year, max_year), n.breaks = 3)+
    scale_y_continuous(labels = scales::label_number(suffix = "m")) +
    theme_classic()+
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3)
  )
    
  }else{
    
    min_year <- min(data_i %>% pull(DIM_TIME))
  max_year <- max(data_i %>% pull(DIM_TIME))
  mid_year <- round((max_year+min_year)/2, digits = 0)
  
  mid_value <- (max(data_i %>% pull(VALUE_NUMERIC))+min(data_i %>% pull(VALUE_NUMERIC)))/2
  perc_label <- round(data_i %>% distinct(perc) %>% pull(perc), 1)
  increase_good <- unique(data_i %>% pull(increase_good))
  color_code <- ifelse(increase_good==0,
                       case_when(perc_label<0 ~ "#80BC00", perc_label>0 ~ "#EF3842", perc_label==0 ~ "#F4A81D"),
                       case_when(perc_label<0 ~ "#EF3842", perc_label>0 ~ "#80BC00", perc_label==0 ~ "#F4A81D")
  )
  arrow_code <- 
    case_when(
    perc_label<0 ~ sprintf('\u2193'),
    perc_label>0 ~ sprintf('\u2191'),
    perc_label==0 ~ sprintf('\u2192'),
  )
  
  plot <- data_i %>% 
    ggplot() +
    labs(title = str_wrap(name, 50))+
    geom_line(aes(x=DIM_TIME, y = VALUE_NUMERIC), color = "#009ADE", size = 1)+
    geom_point(aes(x=DIM_TIME, y = VALUE_NUMERIC), color = "#009ADE", size = 2)+
    # geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(sprintf('%.1f', round(VALUE_NUMERIC, 1)), big.mark = ","))) +
    geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(round(VALUE_NUMERIC, dec_num), big.mark = " ", nsmall = dec_num))) +
    annotate("label", x=max_year, y = mid_value, label = paste0(arrow_code, " ", perc_label, "%"), 
             color = color_code, label.padding = unit(0.8, "lines"), label.r = unit(0.8, "lines")) +
    scale_x_continuous(limits = c(2000, 2025), breaks = c(min_year, max_year), n.breaks = 3)+
    scale_y_continuous(labels=function(x) format(x, big.mark = " ", scientific = FALSE, nsmall = dec_num))+
    theme_classic()+
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3)
  )
  }
  
  assign(paste0("indsc", j), plot)
}

pattern <- grep("indsc", names(.GlobalEnv),value=TRUE)
plot_list <- do.call("list", mget(pattern))
wrap_plots(plot_list, ncol = 2)
```

\newpage

\large Health Statistics: Health Systems
\vspace{-0.5cm}
```{r health systems, fig.height=10.3, fig.width = 8, fig.align='center', message=F, warning=F}

sdg_hs <- sdg_ref %>% 
  filter(group=="health systems") %>% 
  select(IND_UUID, DIM_MEMBER_1_CODE, DIM_MEMBER_2_CODE, increase_good) %>% 
  left_join(sdgtest_)

hs <- rbind(
  sdg_hs %>% group_by(IND_UUID) %>% top_n(1, DIM_TIME) %>% mutate(year = "new"),
  sdg_hs %>% group_by(IND_UUID) %>% top_n(-1, DIM_TIME)%>% mutate(year = "old")
) 
hs_ <- hs %>% 
  select(IND_UUID, IND_CODE, year, VALUE_NUMERIC) %>% 
  pivot_wider(values_from = VALUE_NUMERIC, names_from = year) %>% 
  mutate(perc = ((new-old)/old)*100) %>% 
  mutate(perc_abs = abs(perc)) %>% 
  arrange(desc(perc_abs)) %>% 
  ungroup() %>% 
  # slice(1:6) %>% 
  mutate(graph = 1,
         row = row_number())

hs_final <- hs %>% left_join(hs_)
  
ind_hs <- hs_final %>% filter(graph==1) %>% arrange(row) %>% distinct(IND_UUID) %>%  pull(IND_UUID)

for (j in 1:length(ind_hs)){
  
  message(j)
  i <- unique(hs_final %>% filter(graph==1 & row ==j) %>% pull(IND_UUID))
  name <- sdg_ref %>% filter(IND_UUID==i) %>% pull(website_name) ; message(name)
  
  ind_code <- hs_final %>% filter(IND_UUID==i) %>% distinct(IND_CODE) %>% pull()
  dec_num <- dec_ref %>% filter(DimensionMemberCode==ind_code) %>% pull(decimals); dec_num <- as.numeric(dec_num)
  
  if(i=="BBF3A64"){
    
  data_i <- hs_final %>% filter(IND_UUID==i)
  
  min_year <- min(data_i %>% pull(DIM_TIME))
  max_year <- max(data_i %>% pull(DIM_TIME))
  mid_year <- round((max_year+min_year)/2, digits = 0)
  
  mid_value <- (max(data_i %>% pull(VALUE_NUMERIC))+min(data_i %>% pull(VALUE_NUMERIC)))/2
  perc_label <- round(data_i %>% distinct(perc) %>% pull(perc), 1)
  increase_good <- unique(data_i %>% pull(increase_good))
  color_code <- ifelse(increase_good==0,
                       case_when(perc_label<0 ~ "#80BC00", perc_label>0 ~ "#EF3842", perc_label==0 ~ "#F4A81D"),
                       case_when(perc_label<0 ~ "#EF3842", perc_label>0 ~ "#80BC00", perc_label==0 ~ "#F4A81D")
  )
  arrow_code <- 
    case_when(
    perc_label<0 ~ sprintf('\u2193'),
    perc_label>0 ~ sprintf('\u2191'),
    perc_label==0 ~ sprintf('\u2192'),
  ) 
    plot <- hs_final %>% 
      filter(IND_UUID==i) %>% 
      distinct(DIM_TIME, VALUE_NUMERIC) %>% 
    ggplot(aes(x=DIM_TIME, y = VALUE_NUMERIC)) +
    labs(title = str_wrap(name, 50))+
    geom_line(color = "#009ADE", size = 1)+
    geom_point(color = "#009ADE", size = 2)+
    # geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(sprintf('%.1f', round(VALUE_NUMERIC, 1)), big.mark = ","))) +
    geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(round(VALUE_NUMERIC, dec_num), big.mark = " ", nsmall = dec_num))) +
    scale_x_continuous(limits = c(2000, 2025), breaks = c(min_year, max_year), n.breaks = 3)+
    scale_y_continuous(n.breaks = 4, labels=function(x) format(x, big.mark = " ", scientific = FALSE, nsmall = dec_num))+
    theme_classic()+
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3)
  )
  
  }else{

  data_i <- hs_final %>% filter(IND_UUID==i)
  
  min_year <- min(data_i %>% pull(DIM_TIME))
  max_year <- max(data_i %>% pull(DIM_TIME))
  mid_year <- round((max_year+min_year)/2, digits = 0)
  
  mid_value <- (max(data_i %>% pull(VALUE_NUMERIC))+min(data_i %>% pull(VALUE_NUMERIC)))/2
  perc_label <- round(data_i %>% distinct(perc) %>% pull(perc), 1)
  increase_good <- unique(data_i %>% pull(increase_good))
  color_code <- ifelse(increase_good==0,
                       case_when(perc_label<0 ~ "#80BC00", perc_label>0 ~ "#EF3842", perc_label==0 ~ "#F4A81D"),
                       case_when(perc_label<0 ~ "#EF3842", perc_label>0 ~ "#80BC00", perc_label==0 ~ "#F4A81D")
  )
  arrow_code <- 
    case_when(
    perc_label<0 ~ sprintf('\u2193'),
    perc_label>0 ~ sprintf('\u2191'),
    perc_label==0 ~ sprintf('\u2192'),
  )
  
  plot <- data_i %>% 
    ggplot(aes(x=DIM_TIME, y = VALUE_NUMERIC)) +
    labs(title = str_wrap(name, 50))+
    geom_line(color = "#009ADE", size = 1)+
    geom_point(color = "#009ADE", size = 2)+
    # geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(sprintf('%.1f', round(VALUE_NUMERIC, 1)), big.mark = ","))) +
    geom_text_repel(aes(x=DIM_TIME, y = VALUE_NUMERIC, label = format(round(VALUE_NUMERIC, dec_num), big.mark = " ", nsmall = dec_num))) +
    annotate("label", x=max_year, y = mid_value, label = paste0(arrow_code, " ", perc_label, "%"), 
             color = color_code, label.padding = unit(0.8, "lines"), label.r = unit(0.8, "lines")) +
    scale_x_continuous(limits = c(2000, 2025), breaks = c(min_year, max_year), n.breaks = 3)+
    scale_y_continuous(n.breaks = 4, labels=function(x) format(x, big.mark = " ", scientific = FALSE, nsmall = dec_num))+
    theme_classic()+
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3)
  )
  }
  
  assign(paste0("indhs", j), plot)
}

pattern <- grep("indhs", names(.GlobalEnv),value=TRUE)
plot_list <- do.call("list", mget(pattern))
wrap_plots(plot_list, ncol = 2)
```
\newpage
\normalsize Triple Billions - Number of people affected (millions)
```{r tripbil, fig.height=3.4, fig.width = 8, fig.align='center'}
response <- GET("https://xmart-api-public.who.int/DATA_/RELAY_3B_DATA?$filter=DIM_GEO_CODE_M49%20eq%20'004'")

resultTxt <- content(response, "text")
resultJson <- fromJSON(resultTxt, flatten = T)
tripb <- resultJson$value 

tripb_ <- tripb %>% 
  group_by(DIM_GEO_CODE_M49, TRIPLE_BILLION, DIM_TIME) %>% 
  summarise(contrib = sum(COUNT_N)) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(DIM_TIME)) %>% 
  mutate(tb = case_when(
    TRIPLE_BILLION=="HPOP" ~ "Healthier Populations",
    TRIPLE_BILLION=="HEP" ~ "Health Emergencies Protection",
    TRIPLE_BILLION=="UHC" ~ "Universal Health Coverage"
  )) %>% 
  mutate(contrib_m = round(contrib/1000000, 1))
  
tripb_  %>% 
  filter(year<=2025) %>% 
  ggplot() +
  geom_line(aes(x=year, y = contrib_m, color = tb), show.legend = F, size = 1)+
  geom_point(data = tripb_ %>% filter(year==2025),
             aes(x=year, y = contrib_m, color = tb), show.legend = F, size = 2)+
  geom_text(data = tripb_ %>% filter(year==2025),
            aes(x = 2026, y = contrib_m, label = paste0(contrib_m, "m \n(", str_wrap(tb, 30), ")"), color = tb), 
            show.legend = F, size = 3, vjust=1) +
  scale_x_continuous(breaks = c(2018,2019, 2020, 2021, 2022, 2023, 2024, 2025), limits = c(2018, 2027)) +
  scale_y_continuous(n.breaks = 5, labels = scales::label_number(suffix = "m"), expand = c(0,0)) +
  scale_color_manual(values = c("Healthier Populations" = "#009ADE",
                                "Health Emergencies Protection" = "#A6228C",
                                "Universal Health Coverage" = "#5B2C86"))+
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.border = element_blank(),
    axis.line.y = element_blank(),
    axis.line.x = element_line(color = "darkgrey",linetype = 3),
    panel.grid.major = element_line(color = "darkgrey",size = 0.5,linetype = 3),
    legend.title = element_blank(),
    legend.position = "top"
  )
```
\small In Afghanistan, by 2025 the number of additional people projected to be: enjoying better health and wellbeing is 10.6 million; covered by essential services and not experiencing financial hardship is 1.2 million; and protected from health emergencies is 8 million.
\rule{\textwidth}{0.6pt}\color{whodarkblue}
\normalsize Healthier Populations - individual indicator contributions (millions)
```{r hpopcontrib, fig.align='center', fig.width = 8, fig.height=4}
config_all <- config::get(
  file = "C:\\Users\\samra\\Documents\\WHS_app\\input\\all.yml",
  config = Sys.getenv("USER")
)

get_inds <- function(get_forecast_inds = TRUE, get_billion_inds = FALSE) {
  stopifnot(
    "Exactly one of 'get_forecast_inds' and 'get_billion_inds' can be TRUE" =
      xor(get_forecast_inds, get_billion_inds)
  )
  
  if (get_forecast_inds) {
    inds_possible <- list(
      uhc = billionaiRe::billion_ind_codes("uhc") %>%
        purrr::discard(~.x %in% c("hwf", "fh")),
      hpop = billionaiRe::billion_ind_codes("hpop"),
      hep = billionaiRe::billion_ind_codes("hep", include_subindicators = FALSE) %>%
        purrr::discard(~stringr::str_ends(.x, "_campaign")) %>%
        # don't need since we estimate 'detect_respond' directly
        purrr::discard(~.x %in% c("detect", "respond", "notify")) %>%
        purrr::discard(~.x %in% c("surviving_infants"))
    )
  }
  else if (get_billion_inds) {
    inds_possible <- list(
      uhc = billionaiRe::billion_ind_codes("uhc") %>%
        purrr::discard(~.x %in% c("doctors", "nurses")),
      hpop = billionaiRe::billion_ind_codes("hpop"),
      hep = billionaiRe::billion_ind_codes("hep", include_subindicators = FALSE) %>%
        # don't need since we estimate 'detect_respond' directly
        purrr::discard(~.x %in% c("detect", "respond", "notify")) %>%
        purrr::discard(~.x %in% c("surviving_infants"))
    )
  }
  
  return(inds_possible)
}
inds <- get_inds(get_forecast_inds = FALSE, get_billion_inds = TRUE)
inds$uhc <- c(inds$uhc, "population")
inds$hep <- config_all$hep_intermediate_inds
inds_summary <- c("hpop" = "hpop_healthier", "uhc" = "uhc_billion", "hep" = "hep_idx")

inds_all <- inds %>%
  unlist(use.names = FALSE) %>%
  unique() %>%
  c(inds_summary) %>%
  unname()

`%!in%` = Negate(`%in%`)

all_plt_dat <- all_plt_dat %>% 
      filter(
        country == country_,
        scenario == "baseline",
        ind %in% inds_all,
        year >= config_all$required_start_year,
        year <= 2025,
        year > 2017
      ) %>%
      left_join(ind_labels, by = c("ind", "billion")) %>%
      mutate(name = case_when(name == "Child healthcare" ~ "Child health care", .default = name))

hpop_ind_order <- all_plt_dat %>%
  filter(year == 2025 & billion == "hpop" & ind != "hpop_healthier") %>%
  arrange(abs(contribution)) %>%
  pull(name)
      
hpop_decomp <- all_plt_dat %>%
  mutate(ind = factor(name, levels = c(hpop_ind_order, "Population healthier - HPOP Billion"))) %>%
  filter(billion == "hpop") 

plt_billion = "hpop"
plt_net_ind = "Population healthier - HPOP Billion"
label_years = config_all$years_label_plot %>% c(2019)
size_text = 3
plt_dat = hpop_decomp
  
net_dat <- plt_dat %>%
  filter(ind == plt_net_ind) %>%
  mutate(
    point_label = case_when(
      year %in% label_years ~ contribution_mln %>% round(digits = 0),
      .default = NA_real_
      )
  ) %>%
  select(ind, year, contribution_mln, point_label)
  
calc_label_points <- function(dat) {
    dat %>%
      mutate(
        ind_idx = as.integer(ind),
        ind_label = ind
      ) %>%
      arrange(-ind_idx) %>%
      mutate(
        y_upper_bar = cumsum(contribution_mln),
        y_lower_bar = c(0, y_upper_bar[-n()]),
        y_midpoint = (y_upper_bar + y_lower_bar) / 2,
      ) %>%
      select(ind, ind_idx, ind_label, year, contribution_mln, y_upper_bar, y_lower_bar, y_midpoint)
  }
  
  label_positive_points <- plt_dat %>%
    filter(year == 2025 & contribution_mln >= 0 & ind != plt_net_ind) %>%
    calc_label_points()
  label_negative_points <- plt_dat %>%
    filter(year == 2025 & contribution_mln < 0 & ind != plt_net_ind) %>%
    calc_label_points()
  label_points <- bind_rows(label_positive_points, label_negative_points) %>%
    mutate(
      pct_contribution = abs(contribution_mln) / sum(abs(contribution_mln)) * 100,
      ind_label = case_when(
        plt_billion == "hep" ~ ind,
        pct_contribution > 1 ~ ind,
        .default = NA
      )
    )
  label_ind_in_legend <- label_points %>%
    filter(is.na(ind_label)) %>%
    arrange(ind) %>%
    pull(ind)
  
  plt_dat <- plt_dat %>%
    filter(ind != plt_net_ind) %>%
    mutate(ind_label = if_else(year == 2025, ind, NA)) %>%
    select(ind, year, ind_label, contribution_mln)
  
target_color <- "#F26829" 
below <- label_points %>% 
  filter(contribution_mln < 0) %>% 
  arrange(contribution_mln) %>% 
  distinct(ind) %>% pull()
num_colors <- length(below)
# Number of colors in the gradient
color_gradient <- colorRampPalette(c("#feece0", target_color))(num_colors)
names(color_gradient) <- below

target_color <- "#009ADE"
above <- label_points %>% 
  filter(contribution_mln > 0) %>% 
  arrange(desc(contribution_mln)) %>% 
  distinct(ind) %>% pull()
num_colors <- length(above)
# Number of colors in the gradient
color_gradient2 <- colorRampPalette(c("#ddeff9", target_color))(num_colors)
names(color_gradient2) <- above

color_final <- c(color_gradient2, color_gradient)
ind_sent <- paste(label_ind_in_legend, collapse = ', ')
nudgeing <- net_dat %>% filter(year==2019) %>% pull(contribution_mln)

plt_dat %>%
  # filter(year<=2025) %>% 
    ggplot(aes(x = year, y = contribution_mln)) +
    geom_col(aes(fill = ind), position = "stack", na.rm = F, show.legend = F) +
    geom_line(data = net_dat, aes(y = contribution_mln, color = "Net Contribution"),  color = "black") +
    geom_point(data = net_dat, aes(y = contribution_mln, color = "Net Contribution"), color = "black") +
    geom_text_repel(
      data = label_points,
      mapping = aes(x = 2025.45, y = y_midpoint, label = ind_label), #, color = ind
      color = "black",
      # vjust aligns the segments vertically in the middle of each bar section
      # position = position_stack(vjust = 0.5),
      na.rm = T,
      # align all indicator labels at 20301 onwards and only shift vertically
      direction = "y",
      # nudge_y = 1,
      xlim = c(2026, Inf),
      # still label indicators that are close to equal
      max.overlaps = 100,
      # effectively skip drawing line to label
      # min.segment.length = 100,
      show.legend = FALSE,
      size = size_text
    ) +
  geom_text_repel(
    data = net_dat %>% filter(year==2019),
      aes(x = year, y = contribution_mln, label = "Net contribution"),
      show.legend = F, na.rm = T, size = 3, color = "black",
      nudge_y = nudgeing
    ) +
    geom_hline(yintercept = 0, linetype = "solid", alpha = 0.5) +
    scale_fill_manual(
      values = color_final,
      breaks = label_ind_in_legend
    ) +
    scale_x_continuous(breaks = 2018:2025) +
    scale_y_continuous(n.breaks = 10, labels = scales::label_number(suffix = "m")) +
    theme_classic() +
    # Allow labels to bleed past the canvas boundaries
    coord_cartesian(clip = 'off') +
    theme(
      panel.grid.major.y = element_line(color = "darkgrey"),
      axis.line.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.x=element_text(size=8),
      axis.title.x =element_blank(),
      axis.text.y=element_text(size=8),
      axis.title.y=element_blank(),
      plot.title = element_blank(),
      plot.margin = unit(c(5, 100, 5, 5), "pt"),
    )
```
\small Other indicators below 1% of the total absolute contribution in 2025: `r ind_sent`.

\newpage
\normalsize `r who_region_name`: Triple Billions indicator progress â€“ likelihood of achieving by 2030
```{r heatmap3b, fig.align='center', fig.height=h1}

indicator_values <- filtered_indicator_values %>% 
    filter(year %in% c(2018, 2030)) %>% 
    filter(aggregate_id %in% who_region_countries) %>%
    select(-all_of(c("lower", "upper"))) %>%
    pivot_wider(
      names_from = year,
      values_from = value,
      names_prefix = "mean_value_",
    ) %>%
    mutate(`percentage_change_2018-2030` = 100 * (mean_value_2030 - mean_value_2018) / mean_value_2018,
           within_10p_target = case_when(
             small_is_best ~ mean_value_2030 <= sdg_2030_goal + 0.1 * sdg_2030_goal,
             TRUE ~ mean_value_2030 >= sdg_2030_goal - 0.1 * sdg_2030_goal
           ),
           forecast_likely_exceed_target = case_when(
             small_is_best ~ mean_value_2030 <= sdg_2030_goal,
             TRUE ~  mean_value_2030 >= sdg_2030_goal
           ),
           ach = case_when(forecast_likely_exceed_target ~ "Likely achieve by 2030",
                           within_10p_target ~ "Within 10% of target by 2030",
                           !forecast_likely_exceed_target ~ "Won't achieve by 2030",
                           .default = "Not applicable"),
           mean_value_2018 = round(mean_value_2018, 0),
           mean_value_2030 = round(mean_value_2030, 0),
           `percentage_change_2018-2030` = round(`percentage_change_2018-2030`, 0)) %>% 
    select(
      country,
      aggregation_level,
      aggregate_id,
      billion,
      indicator_name,
      gpw13_indicator_code,
      sdg_code,
      sdg_2030_goal,
      mean_value_2018,
      mean_value_2030,
      `percentage_change_2018-2030`,
      ach
    ) %>% 
  mutate(billion = ifelse(billion == "uhc/hep", "hep", billion)) %>%
  filter(indicator_name %!in% c("Average Service Coverage", "Time to detect and respond", "Prevent", "Developmentally on Track")) %>% 
  arrange(desc(billion), indicator_name)

indicator_values$indicator_name <- factor(indicator_values$indicator_name, 
                                          levels = indicator_values %>% 
                                            distinct(billion, indicator_name) %>% 
                                            arrange(desc(billion), indicator_name) %>% 
                                            pull()
                                          )

indicator_values$ach <- factor(indicator_values$ach, 
                                          levels = c("Likely achieve by 2030",
                                                     "Within 10% of target by 2030", 
                                                     "Won't achieve by 2030", 
                                                     "Not applicable")
                                          )

bh_iso <- ggplot(indicator_values %>% filter(aggregate_id==country_iso), 
       aes(x=indicator_name, y=country, fill=ach, label=ach, family="calibri")) +
    geom_tile(color = "black") +
    theme_classic() +
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size = 8, margin = margin(r = 2, t = 0, l = 2, b = 0, unit = "pt")),
          legend.key.size = unit(0.25, 'cm'),
          axis.title = element_blank(),
          axis.text.x = element_text(angle = -45, hjust=1, size = 8),
          axis.text.y = element_text(face = "bold", size = 8, hjust = 15),
          axis.ticks = element_blank(),
          axis.line = element_blank(), 
          axis.text = element_text(color = "black"),
          plot.margin = unit(c(0, 0, 0, 0), "pt")) +
  scale_fill_manual(values = c("Likely achieve by 2030" = "#80BC00", 
                               "Within 10% of target by 2030"= "#F4A81D", 
                               "Won't achieve by 2030" = "#F26829",
                               "Not applicable" = "grey"),
                    breaks = c("Likely achieve by 2030",
                               "Within 10% of target by 2030",
                               "Won't achieve by 2030"
                               ))+
  scale_x_discrete(position = "top")

bh_reg <- ggplot(indicator_values %>% filter(aggregate_id!=country_iso), 
       aes(x=indicator_name, y=country, fill=ach, label=ach, family="calibri")) +
    geom_tile(color = "black", show.legend = F) +
    theme_classic() +
    theme(axis.title = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 8, hjust = 0),
          axis.ticks = element_blank(),
          axis.line = element_blank(), 
          axis.text = element_text(color = "black"),
          plot.margin = unit(c(4, 0, 0, 0), "pt")) +
  scale_fill_manual(values = c("Won't achieve by 2030" = "#F26829", 
                               "Within 10% of target by 2030"= "#F4A81D", 
                               "Likely achieve by 2030" = "#80BC00", 
                               "Not applicable" = "grey")) +
  scale_y_discrete(limits = rev)

if(who_region=="SEAR"){
  wrap_plots(bh_iso, bh_reg, ncol = 1, heights = c(2, 15))
  }else{
  wrap_plots(bh_iso, bh_reg, ncol = 1, heights = c(1, 25))
}

```

\newpage
\
\
\large \textcolor{black}{Further Resources}
\normalsize
\
\
[\textcolor{websitecolor}{WHO Country website}]("https://www.emro.who.int/countries/afg")
\
\
[\textcolor{websitecolor}{WHO Eastern Mediterranean website}]("https://www.emro.who.int")
\
\
[\textcolor{websitecolor}{WHO Global country page}](`r paste0("https://www.who.int/countries/", "AFG")`)
\
\
[\textcolor{websitecolor}{WHO Global website}](https://www.who.int/)
\
\
\
\
\
\large \textcolor{black}{Data Sources}
\normalsize
```{r resources, warning=F, message=F}
data <- data.frame(
  type = c("Population data",
           "Current Health Expenditure (CHE) as % of GDP",
           "Life expectancy and Healthy life expectancy (HALE)",
           "Causes of death",
           "Disease Burden",
           "Triple Billion"),
  website = c("https://population.un.org/wpp/",
              "https://apps.who.int/nha/database",
              "https://www.who.int/data/gho/data/themes/mortality-and-global-health-estimates/ghe-life-expectancy-and-healthy-life-expectancy",
              "https://www.who.int/data/gho/data/themes/mortality-and-global-health-estimates/ghe-leading-causes-of-death",
              "https://www.who.int/data/gho/data/themes/mortality-and-global-health-estimates/global-health-estimates-leading-causes-of-dalys",
              "https://data.who.int/dashboards/global-progress/triple-billion"
              ),
  name = c("UNDESA population division, World Population Prospects 2022 \nExtracted: May 2024",
            "World Health Organization, Global Health Expenditure database \nExtracted: August 2024",
            "World Health Organization, Global Health Estimates \nExtracted: August 2024",
            "World Health Organization, Global Health Estimates \nExtracted: August 2024",
            "World Health Organization, Global Health Estimates, Burden of Disease \nExtracted: August 2024",
            "World Health Organization, Global Progress Dashboard, Triple Billion targets")
)


dt.ft <- flextable(data = data, col_keys = c("type", "name"))
dt.ft <- compose(x = dt.ft, j = 2, value = as_paragraph( hyperlink_text(x = name, url = website)))
dt.ft <- theme_zebra(dt.ft)
dt.ft <- delete_part(dt.ft, part = "header")
dt.ft <- hline(dt.ft, part = "all", border = fp_border(color = "gray"))
dt.ft <- hline(dt.ft, part = "header", border = fp_border(color = "gray"))
# dt.ft <- set_table_properties(dt.ft, width = 1, layout = "autofit")
dt.ft <- width(dt.ft, j = 1, width = 2, unit = "in")
dt.ft <- width(dt.ft, j = 2, width = 5, unit = "in")
dt.ft <- color(dt.ft, j=2, color = "#0771a0", part = "body")
dt.ft <- fontsize(dt.ft, i = 1:6, j = 1:2, size = 10, part = "body")
dt.ft
```
\
\
\
\
\
\
\
\
\
\
\begin{tcolorbox}[colback=white, colframe=whodarkblue, height=4cm, boxsep=2mm]
Date created: 03/12/2024
\\
\textcolor{websitecolor}{https://data.who.int/countries/004}
\\
\\
Disclaimer: Any designations employed or presentation by the user in its use of this website, including tables and maps, do not imply the expression of any opinion whatsoever on the part of the World Health Organization concerning the legal status of any country, territory, city or area or of its authorities, or concerning the delimitation of its frontiers and boundaries.
\end{tcolorbox}